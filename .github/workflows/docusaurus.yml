name: Docusaurus-website-build

on:
  push:
    branches:
      - master
      - "release/**"
  pull_request:
    branches:
      - "**"

env:
  # Used by docusaurus `publish-site` step
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  REPO_NAME: ${{ github.event.repository.name }}

jobs:
  website-build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repo
        if: github.ref != 'refs/heads/master' || github.repository != 'finos/legend'
        uses: actions/checkout@v3.5.2
      - name: Checkout Repo (default branch)
        if: github.ref == 'refs/heads/master' && github.repository == 'finos/legend'
        uses: actions/checkout@v3.5.2
        with:
          token: ${{ secrets.FINOS_GITHUB_TOKEN }}
      - name: Configure Git
        if: github.ref == 'refs/heads/master' && github.repository == 'finos/legend'
        run: |
          git config --global user.email "37706051+finos-admin@users.noreply.github.com"
          git config --global user.name "FINOS Administrator"
      - name: Setup Node
        uses: actions/setup-node@v3.6.0
        with:
          node-version: 16
      - name: Prepare static artifacts
        run: |
          mkdir website/static/omnibus
          cp -r installers/omnibus/scripts/* website/static/omnibus
          npm install
          npm run update:showcases-index
      # NOTE: ideally, we could make it so that each contributor of showcases can re-generate the index
      # file and commit it as part of their change, but we decide to this like this to lower the entry barrier
      # for contributors, i.e. they don't need to setup Node, follow instructions, etc. locally, they can just
      # contribute directly on Github if they wish to and rely on the pipeline to catch their changes
      - name: Update Showcases Index
        if: github.ref == 'refs/heads/master' && github.repository == 'finos/legend'
        run: |
          git add .
          git commit -m "Update Showcases Index"
          git push
      - name: Build Website
        working-directory: ./website
        run: |
          npm install
          npm run build
      - name: Search for Broken Links
        run: |
          node ./scripts/check-legend-application-documentation-broken-links.js
      - name: Publish Website
        if: github.repository == 'finos/legend' # skip running action in forks
        run: |
          # Extract GitHub org/user
          REPO="${{ github.repository }}"
          GIT_USERNAME=${REPO%/*}
          # Set git user to finos, if it's a push to a finos repo
          if [ "$GIT_USERNAME" == "finos" ] && [ "${{github.event_name }}" == "push" ]
          then GIT_USERNAME="finos"
          elif [ "$GIT_USERNAME" == "finos" ] && [ "${{github.event_name }}" == "pull_request" ]
          then echo "Skipping publishing, as it's coming from a PR"; exit 0
          fi
          # Configure git client
          echo "Git repo - $REPO"
          echo "Git user - $GIT_USERNAME"
          git config --global user.email "$GIT_USERNAME@users.noreply.github.com"
          git config --global user.name "$GIT_USERNAME"
          echo "machine github.com login $GIT_USERNAME password $GITHUB_TOKEN" > ~/.netrc
          GIT_USER=$GIT_USERNAME npm run deploy --prefix website
