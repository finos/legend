<!--
 Copyright 2026 Goldman Sachs

 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.
-->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>PCT Documentation</title>
    <style>
        td { text-align: center; padding-top: 8px; }
        th { position: sticky; top: 0; z-index: 1; background: white; }
        .tooltip-text { visibility: hidden; position: absolute; z-index: 1; color: white; font-size: 12px; background-color: #192733; border-radius: 10px; padding: 10px 15px 10px 15px; }
        .hover-text:hover .tooltip-text { visibility: visible; }
        .hover-text { position: relative; display: inline-block; font-family: Arial; text-align: center; }
        .footer { font-size: 15px; }
        .form-section { margin-bottom: 20px; }
        .form-group { margin-right: 20px; display: inline-block; }
    </style>
    <script>
        function flip(stateId, ids) {
            let state = document.getElementById(stateId).data_openState;
            state = state === undefined ? true : state;
            ids.forEach( (ele) => flipOne(!state, ele));
            document.getElementById(stateId).data_openState = !state;
        }
        function flipOne(open, id) {
            document.getElementById(id).style = open ? 'visibility:true' : 'visibility:collapse';
        }

        class Node {
            constructor(value) {
                this.value = value;
                this.children = {};
            }
        }

        let pctDoc, gitInfo;

        async function loadData() {
            [pctDoc, gitInfo] = await Promise.all([
                fetch('./pct-docs.json').then(r => r.json()),
                fetch('./git-info.json').then(r => r.json())
            ]);
            renderForm();
            renderPCT();
        }

        function getUniqueQualifiers(doc) {
            const qualifiers = new Set();
            doc.functionsDocumentation.forEach(fd => {
                Object.values(fd.functionTestResults || {}).forEach(tr => {
                    (tr.tests || []).forEach(t => (t.qualifiers || []).forEach(q => qualifiers.add(q)));
                });
            });
            return Array.from(qualifiers).sort();
        }

        // Helper: parse query params using repeated parameters
        function getQueryParams() {
            const params = new URLSearchParams(window.location.search);
            return {
                adapters: params.getAll('adapters'),
                qualifiers: params.getAll('qualifiers'),
                skipNoTests: params.get('skipNoTests') === '1' || params.get('skipNoTests') === null
            };
        }

        // Helper: set query params using repeated parameters
        function setQueryParams({adapters, qualifiers, skipNoTests}) {
            const params = new URLSearchParams();
            adapters.forEach(a => params.append('adapters', a));
            qualifiers.forEach(q => params.append('qualifiers', q));
            if (skipNoTests) params.set('skipNoTests', '1');
            const newUrl = window.location.pathname + '?' + params.toString();
            window.history.replaceState({}, '', newUrl);
        }

        function renderForm() {
            const adapters = pctDoc.adapters.map(a => (a.adapter.name === 'Native' ? a.platform : a.adapter.name)).sort();
            const qualifiers = getUniqueQualifiers(pctDoc);
            const urlState = getQueryParams();

            let formHtml = `<form id="pct-form" class="form-section">
            <div class="form-group">
                <label><b>Adapters:</b></label><br>
                ${adapters.map(a => `<label><input type="checkbox" name="adapters" value="${a}"${urlState.adapters.includes(a) ? ' checked' : ''}> ${a}</label><br>`).join('')}
            </div>
            <div class="form-group">
                <label><b>Qualifiers:</b></label><br>
                ${qualifiers.map(q => `<label><input type="checkbox" name="qualifiers" value="${q}"${urlState.qualifiers.includes(q) ? ' checked' : ''}> ${q}</label><br>`).join('')}
            </div>
            <div class="form-group">
                <label><b>Skip functions without tests:</b></label>
                <input type="checkbox" name="skipNoTests"${urlState.skipNoTests ? ' checked' : ''}>
            </div>
        </form>`;
            document.getElementById('pct-form-container').innerHTML = formHtml;

            // Add event listener to update URL and table on input
            document.getElementById('pct-form').oninput = function() {
                const state = getFormParams();
                setQueryParams(state);
                renderPCT();
            };
        }

        function getFormParams() {
            const form = document.getElementById('pct-form');
            const adapters = Array.from(form.querySelectorAll('input[name="adapters"]:checked')).map(i => i.value);
            const qualifiers = Array.from(form.querySelectorAll('input[name="qualifiers"]:checked')).map(i => i.value);
            const skipNoTests = form.querySelector('input[name="skipNoTests"]').checked;
            return { adapters, qualifiers, skipNoTests };
        }

        function groupBy(arr, keyFn) {
            return arr.reduce((acc, item) => {
                const key = keyFn(item);
                if (!acc[key]) acc[key] = [];
                acc[key].push(item);
                return acc;
            }, {});
        }

        function sortBy(arr, keyFn) {
            return arr.slice().sort((a, b) => {
                const ka = keyFn(a), kb = keyFn(b);
                return ka < kb ? -1 : ka > kb ? 1 : 0;
            });
        }

        function escapeHtml(str) {
            return str.replace(/[&<>"']/g, function (m) {
                return ({
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#39;'
                })[m];
            });
        }

        function renderPCT() {
            if (!pctDoc || !gitInfo) return;
            const { adapters, qualifiers, skipNoTests } = getFormParams();

            // Filter adapters
            const filteredAdapters = pctDoc.adapters.filter(a => adapters.length === 0 || adapters.includes(a.adapter.name !== 'Native' ? a.adapter.name : a.platform));
            const groupedAdapters = groupBy(filteredAdapters, a => a.adapter.name !== 'Native' ? a.adapter.group : 'Native');
            const groupNames = Object.keys(groupedAdapters).sort();
            const orderedAdapters = groupNames.flatMap(g => sortBy(groupedAdapters[g], a => a.adapter.name));

            // Filter functions
            let functions = pctDoc.functionsDocumentation;
            if (skipNoTests) {
                functions = functions.filter(fd =>
                    orderedAdapters.some(adapter =>

                        (fd.functionDefinition.signatures.some(s => s.platformOnly) && adapter.adapter.name === 'Native' && qualifiers.length === 0)

                        ||

                        (
                            fd.functionTestResults && fd.functionTestResults[adapter.platform + ':' + adapter.adapter.group + ':' + adapter.adapter.name] &&
                            (fd.functionTestResults[adapter.platform + ':' + adapter.adapter.group + ':' + adapter.adapter.name].tests || []).some(t =>
                                qualifiers.length === 0 ||
                                qualifiers.includes("all") ||
                                t.qualifiers.some(q => qualifiers.includes(q))
                            )
                        )
                    )
                );
            }

            let root = new Node('root');

            functions.forEach(f => {
                let keys = f.functionDefinition.sourceId.substring(f.reportScope.filePath.length, f.functionDefinition.sourceId.lastIndexOf('/')).split('/');
                let node = root;

                keys.forEach((childKey) => {
                    if (!node.children[`__${childKey}`]) {
                        node.children[`__${childKey}`] = new Node(childKey);
                    }
                    node = node.children[`__${childKey}`];
                });

                node.children[f.functionDefinition.name == null ? "composition-tests" : `__${f.functionDefinition.name}`] = new Node(f);
            });

            // Table header
            let table = `<table style="border-spacing:20px 8px;width:900px;text-align: center;max-height:70vh;overflow-y:auto">
                <tr>
                    <th colspan="4" style="width:100px"></th>
                    ${groupNames.map(g => `<th colspan="${groupedAdapters[g].length}">${g}</th>`).join('')}
                </tr>
                <tr>
                    <th style="width:100px"></th>
                    <th style="width:10px">Group</th>
                    <th style="width:200px">Function</th>
                    <th style="width:200px">Signatures & Documentation</th>
                    ${orderedAdapters.map(a => `<th style="width:10px">${a.adapter.name === 'Native' ? a.platform : a.adapter.name}</th>`).join('')}
                </tr>
            `;

            // Helper: test cell
            function testCell(f, adapter) {
                const testResults = f.functionTestResults[adapter.platform + ':' + adapter.adapter.group + ':' + adapter.adapter.name];
                if (!testResults) {
                    if (f.functionDefinition.signatures.some(s => s.platformOnly)) {
                        if (adapter.adapter.name === 'Native') {
                            return `<td><div style="color:#00C72B" class="hover-text">${f.functionDefinition.testCount + '/' + f.functionDefinition.testCount}<div class="tooltip-text" id="top">Platform_function Tests are executed outside of PCT</div></div></td>`;
                        }
                        else {
                            return `<td><div style="color:#AAAAAA" class="hover-text">-<div class="tooltip-text" id="top">Platform_function Tests are executed outside of PCT</div></div></td>`;
                        }
                    } else {
                        return `<td><div style="color:#FF0000" class="hover-text">&#x00A4;<div class="tooltip-text" id="top">No tests (or reports) were found!</div></div></td>`;
                    }
                }
                let tests = testResults.tests || [];
                if (qualifiers.length > 0) {
                    tests = tests.filter(t =>
                        qualifiers.includes("all") ||
                        t.qualifiers.some(q => qualifiers.includes(q))
                    );
                }
                if (tests.length === 0) {
                    const allUnsupported = (testResults.tests || []).every(t => (t.qualifiers || []).includes("unsupportedFeature"));
                    if (allUnsupported) {
                        return `<td><div style="color:#FFA500" class="hover-text">&#x0398<div class="tooltip-text" id="top">Unsupported</div></div></td>`;
                    }
                    return `<td><div style="color:#000000" class="hover-text">[??]<div class="tooltip-text" id="top">Unknown. To Define.</div></div></td>`;
                }
                const successful = tests.filter(t => t.success).length;
                const total = tests.length;
                let color = "#00C72B";
                if (successful === 0) color = "#C70039";
                else if (successful !== total) color = "#FFA500";
                const tooltip = tests
                    .sort((a, b) => (a.testName || '').localeCompare(b.testName || ''))
                    .map(t =>
                        `<span style="color:${t.success ? "#00FF00" : "#FF0000"}">${t.testName}</span><span>${t.errorMessage ? t.errorMessage : ""}</span>`
                    ).join("<br>");
                return `<td><div style="color:${color}" class="hover-text">${successful}/${total}<div class="tooltip-text" id="top">${tooltip}</div></div></td>`;
            }

            function funcNameCell(funcDoc) {
                const f = funcDoc.functionDefinition;
                const module = funcDoc.reportScope.module;
                let color = "#000000";
                if (f.signatures.some(s => s.platformOnly)) color = "#DDDDDD";
                else if (f.name == null) color = "#79d6db";
                let character = f.signatures.find(s => s.grammarCharacter != null)?.grammarCharacter;
                const commitId = gitInfo['git.commit.id'] || "master";
                const moduleURLs = {
                    grammar: "https://github.com/finos/legend-pure/tree/master/legend-pure-core/legend-pure-m3-core/src/main/resources",
                    essential: "https://github.com/finos/legend-pure/tree/master/legend-pure-core/legend-pure-m3-core/src/main/resources",
                    standard: `https://github.com/finos/legend-engine/tree/${commitId}/legend-engine-core/legend-engine-core-pure/legend-engine-pure-code-functions-standard/legend-engine-pure-functions-standard-pure/src/main/resources`,
                    relation: `https://github.com/finos/legend-engine/tree/${commitId}/legend-engine-core/legend-engine-core-pure/legend-engine-pure-code-functions-relation/legend-engine-pure-functions-relation-pure/src/main/resources`,
                    unclassified: `https://github.com/finos/legend-engine/tree/${commitId}/legend-engine-core/legend-engine-core-pure/legend-engine-pure-code-functions-unclassified/legend-engine-pure-functions-unclassified-pure/src/main/resources`,
                    core_scenario_quant: `https://github.com/finos/legend-engine/tree/${commitId}/legend-engine-core/legend-engine-core-pure/legend-engine-pure-code-scenario-quant-pure/src/main/resources`
                };
                const url = moduleURLs[module] ? moduleURLs[module] + f.sourceId : "#";
                return (character ? `<span style="color:#34eb92">${character}&nbsp;&nbsp;</span>` : "") +
                    `<a href="${url}" style="color:${color}" target="_blank">${f.name == null ? "composition-tests" : f.name}</a>`;
            }

            function funcSignaturesCell(funcDoc) {
                const f = funcDoc.functionDefinition;
                if (!f.signatures || f.signatures.length === 0) return "";
                return `<table style="width:1000px;table-layout:fixed;"><tr>` +
                    f.signatures.map(sig =>
                        `<td style="text-align:left;">${escapeHtml(sig.simple.substring(sig.simple.indexOf(f.name + "(")))}</td>` +
                        `<td style="text-align:left;">${escapeHtml(sig.documentation || "")}</td>`
                    ).join("</tr><tr>") +
                    `</tr></table>`;
            }

            function nodeChildrenIds(node, id) {
                return Object.keys(node.children).flatMap(k =>{
                    let curr = id + (typeof node.children[k].value === 'string' ? node.children[k].value : (node.children[k].value.functionDefinition.name == null ? "composition-tests" : node.children[k].value.functionDefinition.name));
                    return nodeChildrenIds(node.children[k], curr).concat([curr]);
                });
            }

            function processNode(node, tab, id) {
                let keys = Object.keys(node.children).sort();

                if (keys.length === 0)
                {
                    let f = node.value;
                    id += f.functionDefinition.name == null ? "composition-tests" : f.functionDefinition.name;

                    table += `<tr id = '${id}'>
                        <td></td>
                        <td><div style="color:#AAAAAA">${f.reportScope.module}</div></td>
                        <td>${funcNameCell(f)}</td>
                        <td>${funcSignaturesCell(f)}</td>
                        ${orderedAdapters.map(adapter => testCell(f, adapter)).join('')}
                    </tr>`;
                }
                else {
                    if (node.value !== 'root')
                    {
                        let pos = tab.length === 0 ? 'top' : 'bottom';

                        id += node.value;

                        // todo recurse to get all keys
                        const children = nodeChildrenIds(node, id).map(x => `'${x}'`);

                        table += `<tr id = '${id}'>
                        <td style='${'text-align:left!important;' + (tab.length !== 0 ? '' : `border-${pos}-style:solid!important;border-${pos}-width:1px!important;`) + (tab.length === 0 ? `border-${pos}-color:#000000;` : `border-${pos}-color:#EEEEEE;`)}'>
                            <a onclick="flip('${id}', [${children.join(', ')}])">
                            ${tab + node.value}
                            </a>
                        </td>
                        <td style='${`border-${pos}-style:solid!important;border-${pos}-width:1px!important;` + ((tab.length === 0) ? `border-${pos}-color:#000000;` : `border-${pos}-color:#EEEEEE;`)}'>&nbsp;</td>
                        <td style='${`border-${pos}-style:solid!important;border-${pos}-width:1px!important;` + ((tab.length === 0) ? `border-${pos}-color:#000000;` : `border-${pos}-color:#EEEEEE;`)}'>&nbsp;</td>
                        <td style='${`border-${pos}-style:solid!important;border-${pos}-width:1px!important;` + ((tab.length === 0) ? `border-${pos}-color:#000000;` : `border-${pos}-color:#EEEEEE;`)}'>&nbsp;</td>
                        </tr>`;

                        tab += '&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;';
                    }

                    keys.forEach(k => {
                        processNode(node.children[k], tab, id);
                    });
                }
            }

            processNode(root, '', '');

            // Successful Test Rate row
            table += `<tr>
                <td></td>
                <td></td>
                <td><div style="color:#AAAAAA">Successful Test Rate</div></td>
                <td></td>
                ${orderedAdapters.map(adapter => {
                let successful = 0, total = 0;
                functions.forEach(funcDoc => {
                    const tr = funcDoc.functionTestResults && funcDoc.functionTestResults[adapter.platform + ':' + adapter.adapter.group + ':' + adapter.adapter.name];
                    if (tr && tr.tests) {
                        let tests = tr.tests;
                        if (qualifiers.length > 0) {
                            tests = tests.filter(t =>
                                qualifiers.includes("all") ||
                                t.qualifiers.some(q => qualifiers.includes(q))
                            );
                        }
                        successful += tests.filter(t => t.success).length;
                        total += tests.length;
                    }
                });
                if (total > 0) {
                    return `<td><div style="color:#000000" class="hover-text">${Math.floor(successful / total * 100)}%<div class="tooltip-text" id="top"><span style="color:#FFFFFF">${successful}/${total}</span></div></div></td>`;
                } else {
                    return `<td><div style="color:#AAAAAA">&empty;</div></td>`;
                }
            }).join('')}
            </tr>`;

            table += "</table><br/><br/><br/>";
            document.getElementById('pct-table').innerHTML = table;
            document.getElementById('pct-footer').innerHTML =
                `PCT results as of ${gitInfo['git.commit.time'] || ""} using commit <a href="https://github.com/finos/legend-engine/tree/${gitInfo['git.commit.id'] || "master"}" target="_blank">${gitInfo['git.commit.id'] || "master"}</a>.`;
        }

        window.addEventListener('DOMContentLoaded', loadData);
    </script>
</head>
<body>
<br/><br/>
<div id="pct-form-container"></div>
<div id="pct-table"></div>
<br/><br/><br/>
<footer class="footer" id="pct-footer"></footer>
</body>
</html>